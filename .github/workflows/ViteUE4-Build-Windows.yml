name: UE4 Optimized Build (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      buildConfig:
        description: 'Build Configuration'
        required: true
        default: 'Development'
        type: choice
        options: [Development, Shipping]

jobs:
  build:
    runs-on: windows-2019
    env:
      UE_ROOT: X:\
      PROJECT_DIR: ${{ github.workspace }}\project
      UPROJECT: "${{ github.workspace }}\\project\\ActionRPG - Vite\\ActionRPG.uproject"
      OUTPUT_DIR: ${{ github.workspace }}\project\release

    steps:
      - name: Enable long paths
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f
          git config --system core.longpaths true

      - name: Checkout UE4 Engine
        uses: actions/checkout@v4
        with:
          repository: GapingPixel/UnrealEngineVite-PhysX
          path: ue
          lfs: true
          token: ${{ secrets.UE_PAT }}

      - name: Map UE to X drive
        shell: cmd
        run: |
          subst X: "%GITHUB_WORKSPACE%\ue"
          
      - name: Setup UBT BuildConfiguration
        shell: powershell
        run: |
          $xmlPath = "$env:AppData\Unreal Engine\UnrealBuildTool\BuildConfiguration.xml"
          $directory = [System.IO.Path]::GetDirectoryName($xmlPath)
          if (!(Test-Path $directory)) { New-Item -ItemType Directory -Force -Path $directory }
          $xmlContent = @"
          <?xml version="1.0" encoding="utf-8" ?>
          <Configuration xmlns="https://www.unrealengine.com/BuildConfiguration">
              <WindowsPlatform>
                  <WindowsSdkVersion>10.0.19041.0</WindowsSdkVersion>
              </WindowsPlatform>
          </Configuration>
          "@
          Set-Content -Path $xmlPath -Value $xmlContent

      - name: Sync Dependencies
        shell: cmd
        run: |
          X:
          echo N | Engine\Binaries\DotNET\GitDependencies.exe --exclude=Mac --exclude=Linux --exclude=Android --exclude=IOS

      - name: Generate Project Files
        shell: cmd
        run: |
          X:
          GenerateProjectFiles.bat

      - name: Checkout Game Project
        uses: actions/checkout@v4
        with:
          repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
          path: project
          lfs: true

      - name: Resolve Build Config
        shell: powershell
        run: |
          $cfg = "${{ github.event.inputs.buildConfig }}"
          if ([string]::IsNullOrWhiteSpace($cfg)) { $cfg = "Development" }
          echo "BUILD_CONFIG=$cfg" >> $env:GITHUB_ENV

      - name: Build UAT & ShaderWorkers
        shell: cmd
        run: |
          X:
          "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe" Engine\Source\Programs\AutomationTool\AutomationTool.csproj /p:Configuration=Development /p:Platform=AnyCPU
          Engine\Build\BatchFiles\Build.bat ShaderCompileWorker Win64 Development -WaitMutex

      - name: Compile RTXGI Plugin Manually
        shell: cmd
        run: |
          X:
          :: Use RunUAT to build the plugin specifically. This generates the missing DLLs.
          Engine\Build\BatchFiles\RunUAT.bat BuildPlugin -Plugin="X:\Engine\Plugins\Runtime\Nvidia\RTXGI\RTXGI.uplugin" -Package="%TEMP%\RTXGI" -Rocket -unattended

      - name: Build Editor
        shell: cmd
        run: |
          X:
          :: Now build the Editor. Since we built the plugin above, it should find the binaries.
          Engine\Build\BatchFiles\Build.bat UE4Editor Win64 Development -Project="%UPROJECT%" -WaitMutex -NoHotReload

      - name: Build Game Binaries
        shell: cmd
        run: |
          X:
          Engine\Build\BatchFiles\Build.bat ActionRPG Win64 %BUILD_CONFIG% -Project="%UPROJECT%" -NoHotReload

      - name: Package Project
        shell: cmd
        run: |
          X:
          :: We use -nullrhi and ensure we aren't skipping the build in case DLLs need a final link
          Engine\Build\BatchFiles\RunUAT.bat BuildCookRun ^
            -project="%UPROJECT%" ^
            -noP4 -platform=Win64 -clientconfig=%BUILD_CONFIG% ^
            -cook -allmaps -stage -pak -archive ^
            -archivedirectory="%OUTPUT_DIR%" ^
            -unattended -nullrhi -ni

      - name: Collect Logs on Failure
        if: failure()
        shell: cmd
        run: |
          subst X: "%GITHUB_WORKSPACE%\ue"
          mkdir build_logs
          dir X:\Engine\Plugins\Runtime\Nvidia\RTXGI\Binaries\Win64\ > build_logs\rtxgi_binaries_list.txt
          xcopy /s /y X:\Engine\Programs\AutomationTool\Saved\Logs\* build_logs\
          xcopy /y X:\Engine\Programs\AutomationTool\Saved\Cook*.txt build_logs\

      - name: Upload Error Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Failure-Diagnostics
          path: build_logs/
