name: UE4 Minimal Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019

    steps:

    # -------------------------------------------------
    # Enable Windows + Git long paths
    # -------------------------------------------------
    - name: Enable Windows long paths
      shell: powershell
      run: |
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
    - name: Enable git long paths
      shell: powershell
      run: git config --system core.longpaths true

    # -------------------------------------------------
    # Checkout UE4 Custom Engine
    # -------------------------------------------------
    - name: Checkout UE4 Custom Engine
      uses: actions/checkout@v4
      with:
        repository: GapingPixel/UnrealEngineVite-PhysX
        path: ue
        lfs: true
        token: ${{ secrets.UE_PAT }}

    # -------------------------------------------------
    # Map UE4 to drive X: (avoid long path issues)
    # -------------------------------------------------
    - name: Map UE4 to drive X
      shell: cmd
      run: |
        subst X: "%GITHUB_WORKSPACE%\ue"

    # -------------------------------------------------
    # Cache GitDependencies
    # -------------------------------------------------
    - name: Cache UE4 Dependencies
      uses: actions/cache@v4
      with:
        path: ue\.git\ue4-gitdeps
        key: ue4-gitdeps-4.27

    # -------------------------------------------------
    # Sync UE4 Dependencies (Windows only)
    # -------------------------------------------------
    - name: Sync UE4 Dependencies
      shell: cmd
      run: |
        cd /d X:\
        Engine\Binaries\DotNET\GitDependencies.exe ^
          --exclude=Mac ^
          --exclude=Linux ^
          --exclude=Android ^
          --exclude=IOS ^
          --exclude=TVOS ^
          --exclude=WinRT ^
          --exclude=HTML5 ^
          --threads=16

    # -------------------------------------------------
    # Generate Project Files
    # -------------------------------------------------
    - name: Generate Project Files
      shell: cmd
      run: |
        cd /d X:\
        GenerateProjectFiles.bat

    # -------------------------------------------------
    # Checkout Game Project
    # -------------------------------------------------
    - name: Checkout Project
      uses: actions/checkout@v4
      with:
        repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
        path: project
        lfs: true

    # -------------------------------------------------
    # Build Game Target ONLY (Minimal Engine Build)
    # -------------------------------------------------
    - name: Build Game
      shell: powershell
      run: |
        $uproject = "$env:GITHUB_WORKSPACE\project\ActionRPG - Vite\ActionRPG.uproject"
        if (!(Test-Path $uproject)) {
            Write-Error "UPROJECT NOT FOUND!"
            exit 1
        }
        Write-Host "Building minimal engine + game target..."
        & "X:\Engine\Build\BatchFiles\Build.bat" `
          ActionRPG `
          Win64 `
          Development `
          -Project="$uproject" `
          -NoDebugInfo `
          -NoHotReload
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        Write-Host "Build completed successfully."

    # -------------------------------------------------
    # Search for built files dynamically
    # -------------------------------------------------
    - name: Find Build Output
      shell: powershell
      run: |
        $binaries = Get-ChildItem -Path "$env:GITHUB_WORKSPACE\project\Binaries" -Recurse -File -ErrorAction SilentlyContinue
        $saved = Get-ChildItem -Path "$env:GITHUB_WORKSPACE\project\Saved" -Recurse -File -ErrorAction SilentlyContinue

        if ($binaries.Count -eq 0 -and $saved.Count -eq 0) {
            Write-Warning "No files found in Binaries or Saved folders!"
        } else {
            Write-Host "Found build files:"
            $binaries + $saved | ForEach-Object { Write-Host $_.FullName }
        }

        # Save the found paths to variables for upload
        $binaries | ForEach-Object { $_.FullName } | Out-File "$env:GITHUB_WORKSPACE\binaries.txt"
        $saved | ForEach-Object { $_.FullName } | Out-File "$env:GITHUB_WORKSPACE\saved.txt"

    # -------------------------------------------------
    # Upload Build Artifacts
    # -------------------------------------------------
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MinimalGameBuild
        path: |
          $(Get-Content "$env:GITHUB_WORKSPACE\binaries.txt")
          $(Get-Content "$env:GITHUB_WORKSPACE\saved.txt")