name: UE4 Minimal Engine + Project Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:

    # -------------------------------------------------
    # 1️⃣ Enable Windows Long Paths
    # -------------------------------------------------
    - name: Enable long paths (Windows)
      shell: powershell
      run: |
        New-ItemProperty `
          -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" `
          -Value 1 `
          -PropertyType DWORD `
          -Force

    - name: Enable git long paths
      run: git config --system core.longpaths true

    # -------------------------------------------------
    # 2️⃣ Free as much disk space as possible
    # -------------------------------------------------
    - name: Free disk space
      shell: cmd
      run: |
        echo Freeing disk space...
        rd /s /q "C:\Program Files (x86)\Microsoft Visual Studio\2022\Enterprise" 2>nul
        rd /s /q "C:\Program Files\dotnet" 2>nul
        rd /s /q "C:\ProgramData\Chocolatey" 2>nul
        del /f /s /q C:\*.tmp 2>nul

    # -------------------------------------------------
    # 3️⃣ Checkout UE4 Source
    # -------------------------------------------------
    - name: Checkout UE4.27 Source
      uses: actions/checkout@v4
      with:
        repository: AlexMercer-MA/UnrealEngine-4.27
        path: UE4
        lfs: true

    # Move engine to short root path to avoid MAX_PATH
    - name: Move UE4 to C:\UE4
      shell: cmd
      run: |
        move UE4 C:\UE4

    # -------------------------------------------------
    # 4️⃣ Minimal Setup (Win64 only)
    # -------------------------------------------------
    - name: Setup UE4 minimal (Win64 only)
      shell: cmd
      run: |
        cd C:\UE4
        Setup.bat -exclude=Mac -exclude=Linux -exclude=Android -exclude=IOS -exclude=TVOS -exclude=WinRT -exclude=HTML5

    # -------------------------------------------------
    # 5️⃣ Generate Project Files
    # -------------------------------------------------
    - name: Generate Project Files
      shell: cmd
      run: |
        cd C:\UE4
        GenerateProjectFiles.bat

    # -------------------------------------------------
    # 6️⃣ Build Minimal Engine Target (NO EDITOR)
    # -------------------------------------------------
    - name: Build UE4Game (Development Win64)
      shell: cmd
      run: |
        cd C:\UE4
        Engine\Build\BatchFiles\Build.bat UE4Game Win64 Development -NoDebugInfo -NoHotReload

    # Optional cleanup to reduce disk before project build
    - name: Cleanup Engine Intermediate
      shell: cmd
      run: |
        rd /s /q C:\UE4\Engine\Intermediate 2>nul

    # -------------------------------------------------
    # 7️⃣ Checkout Your Project
    # -------------------------------------------------
    - name: Checkout Project
      uses: actions/checkout@v4
      with:
        repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
        path: Project
        lfs: true

    # -------------------------------------------------
    # 8️⃣ Build Project (Game target only)
    # -------------------------------------------------
    - name: Build ActionRPG Game Target
      shell: cmd
      run: |
        C:\UE4\Engine\Build\BatchFiles\Build.bat ActionRPG Win64 Development ^
        -Project="%CD%\Project\ActionRPG - Vite\ActionRPG.uproject" ^
        -NoDebugInfo -NoHotReload
