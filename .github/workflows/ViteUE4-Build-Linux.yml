name: UE4 Minimal Build (Linux)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # =================================================
    # NOTE: LINUX-ONLY WORKFLOW
    # =================================================
    # This workflow is intended for LINUX ONLY.
    #
    # Linux uses clang + lld, which is STRICTER than
    # MSVC on Windows.
    #
    # Common Linux-only Unreal failures:
    # -----------------------------------
    # 1. Missing log category definitions:
    #      ld.lld: error: undefined symbol: LogAbilities
    #
    #    Fix:
    #      - DECLARE_LOG_CATEGORY_EXTERN(LogAbilities, Log, All);
    #        must exist in a header
    #      - DEFINE_LOG_CATEGORY(LogAbilities);
    #        must exist in EXACTLY ONE .cpp
    #
    #    Windows may "work" without this. Linux will not.
    #
    # 2. Random "OtherCompilationError":
    #      Usually NOT a code error.
    #      Almost always CI resource limits:
    #        - OOM killer
    #        - runner watchdog timeout
    #        - disk exhaustion
    #
    # This CI adds:
    #   - Large swap
    #   - Reduced parallelism
    #   - Extra logging to detect OOM/timeouts
    #
    # =================================================

    runs-on: blacksmith-4vcpu-ubuntu-2204

    steps:

    # -------------------------------------------------
    # Show system info early (helps debug CI limits)
    # -------------------------------------------------
    - name: System Info
      run: |
        uname -a
        lsb_release -a || true
        nproc
        free -h
        df -h

    # -------------------------------------------------
    # Aggressive cleanup to free disk space
    # -------------------------------------------------
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo rm -rf /home/runner/.cache /home/runner/.npm /home/runner/.local/share /home/runner/.dotnet
        sudo apt-get clean
        sudo apt-get remove -y '^aspnetcore-.*' || true
        sudo apt-get remove -y '^llvm-.*' || true
        sudo apt-get remove -y 'php.*' || true
        sudo apt-get remove -y '^mongodb-.*' || true
        sudo apt-get remove -y '^mysql-.*' || true
        sudo apt-get remove -y azure-cli google-chrome-stable firefox powershell || true
        sudo apt-get autoremove -y || true
        sudo docker image prune --all --force || true
        sudo swapoff -a || true
        sudo rm -rf /usr/lib/jvm /usr/share/swift /opt/hostedtoolcache
        free -h
        df -h

    # -------------------------------------------------
    # Enable LARGE swap (critical for UE4 on Linux CI)
    # -------------------------------------------------
    - name: Enable swap (32GB)
      run: |
        sudo fallocate -l 32G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h
        swapon --show

    # -------------------------------------------------
    # Install UE4 Linux dependencies
    # -------------------------------------------------
    - name: Install UE4 Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang lld mono-complete \
          libicu-dev libssl-dev libxcb-xinerama0-dev libxrandr-dev \
          libxinerama-dev libxi-dev libxss-dev libgl1-mesa-dev \
          libgtk-3-dev cmake ninja-build git wget unzip ccache
        df -h

    # -------------------------------------------------
    # Checkout UE4 Custom Engine
    # -------------------------------------------------
    - name: Checkout UE4 Custom Engine
      uses: actions/checkout@v4
      with:
        repository: GapingPixel/UnrealEngineVite-PhysX
        path: ue
        lfs: true
        token: ${{ secrets.UE_PAT }}

    # -------------------------------------------------
    # Setup UE4 Engine (Linux)
    # -------------------------------------------------
    - name: Setup UE4 Engine
      run: |
        set -o pipefail
        cd ue

        # Clear kernel logs so OOM is easy to spot later
        sudo dmesg --clear || true

        ./Setup.sh
        ./GenerateProjectFiles.sh

        # NOTE:
        # Using FULL CPU parallelism (-j$(nproc))
        # often causes OOM on CI.
        #
        # If this still fails, reduce to -j1.
        make -j2 VERBOSE=1 | tee ue4-build.log

        df -h
        free -h

        # Dump kernel messages in case the build was killed
        sudo dmesg | tail -n 100 || true

    # -------------------------------------------------
    # Upload UE4 Build Logs (always)
    # -------------------------------------------------
    - name: Upload UE4 Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ue4-build-logs
        path: |
          ue/ue4-build.log
          ue/Engine/Programs/UnrealBuildTool/Log.txt

    # -------------------------------------------------
    # Checkout Game Project
    # -------------------------------------------------
    - name: Checkout Game Project
      uses: actions/checkout@v4
      with:
        repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
        path: project
        lfs: true

    # -------------------------------------------------
    # Build Game Target (Linux Server Only)
    # -------------------------------------------------
    - name: Build Game Target
      run: |
        set -o pipefail

        sudo dmesg --clear || true

        UPROJECT=$(find "$GITHUB_WORKSPACE/project" -name "*.uproject" | head -n 1)
        if [ -z "$UPROJECT" ]; then
          echo "UPROJECT NOT FOUND!"
          exit 1
        fi

        echo "Using uproject: $UPROJECT"
        echo "Building Linux server target..."

        ue/Engine/Build/BatchFiles/Linux/Build.sh \
          ActionRPGServer Linux Development \
          -Project="$UPROJECT" \
          -NoHotReload \
          -TargetType=Server | tee game-build.log

        free -h
        df -h
        sudo dmesg | tail -n 100 || true

    # -------------------------------------------------
    # Upload Game Build Logs
    # -------------------------------------------------
    - name: Upload Game Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: game-build-logs
        path: |
          game-build.log

    # -------------------------------------------------
    # Cleanup editor binaries to save space
    # -------------------------------------------------
    - name: Cleanup Engine Binaries
      run: |
        cd ue
        rm -rf Engine/Binaries/Linux/UE4Editor
        rm -rf Engine/Binaries/Linux/UE4Game
        rm -rf Engine/Binaries/Linux/ShaderCompileWorker
        df -h

    # -------------------------------------------------
    # Upload Build Artifacts
    # -------------------------------------------------
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MinimalGameBuild_Linux
        path: |
          project/Binaries
          project/Saved
